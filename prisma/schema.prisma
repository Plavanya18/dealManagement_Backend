generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum CustomerType {
  corporate
  retail
}

enum DealType {
  buy
  sell
}

enum RiskLevel {
  low
  medium
  high
}

enum PaymentMode {
  cash
  bank_transfer
}

enum SessionStatus {
  active
  inactive
  terminated
  timeout
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  created_at  DateTime
  updated_at  DateTime
  users       User[]
  permissions RolePermission[]
}

model Permission {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  created_at  DateTime
  updated_at  DateTime
  roles       RolePermission[]
}

model RolePermission {
  id            Int         @id @default(autoincrement())
  role_id       Int
  permission_id Int
  role          Role        @relation(fields: [role_id], references: [id])
  permission    Permission  @relation(fields: [permission_id], references: [id])
}

model Branch {
  id              Int           @id @default(autoincrement())
  name            String        @unique
  is_active       Boolean       @default(true)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  users  User[]
  deals  Deal[]
}

model User {
  id                      Int             @id @default(autoincrement())
  full_name               String
  email                   String          @unique
  password                String
  role_id                 Int?
  branch_id               Int?
  is_active               Boolean
  must_change_password    Boolean
  password_last_changed   DateTime?
  deactivated_at          DateTime?
  deactivated_by          Int?
  deactivation_reason     String?
  deleted_by              Int?
  force_logout            Boolean         @default(false)
  last_login              DateTime?
  created_at              DateTime
  updated_at              DateTime
  deleted_at              DateTime?
  branch                  Branch?         @relation(fields: [branch_id], references: [id])
  role                    Role?           @relation(fields: [role_id], references: [id])
  deactivatedBy           User?           @relation("UserDeactivatedBy", fields: [deactivated_by], references: [id])
  deactivatedUsers        User[]          @relation("UserDeactivatedBy")
  deletedBy               User?           @relation("UserDeletedBy", fields: [deleted_by], references: [id])
  deletedUsers            User[]          @relation("UserDeletedBy")
  userDetail              UserDetail?
  sessions                UserSession[]
  customersVerified       Customer[]      @relation("KycVerifiedBy")
  customersDeactivated    Customer[]      @relation("CustomerDeactivatedBy")
  customersCreated        Customer[]      @relation("CustomerCreatedBy")
  kycDocumentsUploaded    KycDocument[]   @relation("UploadedBy")
  kycDocumentsVerified    KycDocument[]   @relation("VerifiedBy")
  customerBanksCreated    CustomerBank[]  @relation("CustomerBankCreatedBy")
  customerBanksDeleted    CustomerBank[]  @relation("CustomerBankDeletedBy")
  systemBanksCreated      SystemBank[]    @relation("SystemBankCreatedBy")
  dealsCreated            Deal[]          @relation("DealCreatedBy")
  dealsApproved           Deal[]          @relation("DealApprovedBy")
  paymentsProcessed       Payment[]       @relation("PaymentProcessedBy")
  paymentsApproved        Payment[]       @relation("PaymentApprovedBy")
  fxRatesCreated          FxRate[]        @relation("FxRateCreatedBy")
  uploadedDocuments       DealDocument[]  @relation("UserUploadedDocuments")
  auditLogs               AuditLog[]
  notifications           SystemNotification[]
}

model UserDetail {
  id                  Int       @id @default(autoincrement())
  user_id             Int       @unique
  password_expiry_date DateTime?
  failed_login_attempts Int
  last_failed_login   DateTime?
  reason              String?
  created_at          DateTime
  updated_at          DateTime
  user                User      @relation(fields: [user_id], references: [id])
}

model IpAddress {
  id          Int           @id @default(autoincrement())
  ip_address  String        @unique
  location    String?
  country     String?
  isp         String?
  device_info String?
  created_at  DateTime
  sessions    UserSession[]
}

model UserSession {
  id              Int           @id @default(autoincrement())
  user_id         Int
  token           String        @db.Text   
  ip_id           Int?
  device_info     String?
  session_status  SessionStatus @default(active)
  login_time      DateTime
  logout_time     DateTime?
  last_activity   DateTime?
  created_at      DateTime
  updated_at      DateTime
  user            User          @relation(fields: [user_id], references: [id])
  ip              IpAddress?    @relation(fields: [ip_id], references: [id])
}

model Customer {
  id                    Int              @id @default(autoincrement())
  customer_type         CustomerType
  name                  String
  tax_id                String?
  business_license_no   String?
  id_number             String?
  email                 String?
  phone_number          String?
  phone_verified        Boolean?
  contact_number        String?
  address               String?
  city                  String?
  state                 String?
  postal_code           String?
  country               String?
  verified              Boolean?
  kyc_verified_by       Int?
  kyc_verified_at       DateTime?
  risk_level            RiskLevel        @default(low)
  risk_reason           String?
  compliance_remarks    String?
  deactivated_at        DateTime?
  deactivated_by        Int?
  deactivation_reason   String?
  remarks               String?
  created_by            Int?
  created_at            DateTime
  updated_at            DateTime
  kycDocuments          KycDocument[]
  banks                 CustomerBank[]
  deals                 Deal[]
  kycVerifiedBy         User?            @relation("KycVerifiedBy", fields: [kyc_verified_by], references: [id])
  deactivatedBy         User?            @relation("CustomerDeactivatedBy", fields: [deactivated_by], references: [id])
  createdBy             User?            @relation("CustomerCreatedBy", fields: [created_by], references: [id])
}

model KycDocument {
  id            Int       @id @default(autoincrement())
  customer_id   Int
  document_type String
  file_name     String
  file_path     String
  mime_type     String?
  uploaded_by   Int?
  verified      Boolean?
  verified_by   Int?
  uploaded_at   DateTime
  verified_at   DateTime?
  deleted_at    DateTime?
  customer      Customer  @relation(fields: [customer_id], references: [id])
  uploadedBy    User?     @relation("UploadedBy", fields: [uploaded_by], references: [id])
  verifiedBy    User?     @relation("VerifiedBy", fields: [verified_by], references: [id])
}

model Currency {
  id             Int             @id @default(autoincrement())
  code           String          @unique
  name           String
  country        String?
  decimal_places Int
  is_active      Boolean
  created_at     DateTime
  updated_at     DateTime
  customerBanks  CustomerBank[]
  dealsBase      Deal[]          @relation("BaseCurrency")
  dealsQuote     Deal[]          @relation("QuoteCurrency")
  payments       Payment[]
  fxRatesBase    FxRate[]        @relation("BaseRate")
  fxRatesQuote   FxRate[]        @relation("QuoteRate")
}

model CustomerBank {
  id             Int        @id @default(autoincrement())
  customer_id    Int
  bank_name      String
  branch_name    String?
  account_number String
  swift_code     String?
  country        String?
  currency_id    Int
  is_primary     Boolean
  is_active      Boolean
  is_dormant     Boolean
  created_by     Int?
  deleted_by     Int?
  created_at     DateTime
  updated_at     DateTime
  deleted_at     DateTime?
  customer       Customer   @relation(fields: [customer_id], references: [id])
  currency       Currency   @relation(fields: [currency_id], references: [id])
  createdBy      User?      @relation("CustomerBankCreatedBy", fields: [created_by], references: [id])
  deletedBy      User?      @relation("CustomerBankDeletedBy", fields: [deleted_by], references: [id])
  payments       Payment[]
}

model SystemBank {
  id             Int        @id @default(autoincrement())
  name           String
  swift_code     String     @unique
  branch_name    String?
  account_number String?
  address        String?
  country        String?
  contact_person String?
  contact_number String?
  created_by     Int?
  created_at     DateTime
  updated_at     DateTime
  deleted_at     DateTime?
  createdBy      User?      @relation("SystemBankCreatedBy", fields: [created_by], references: [id])
  payments       Payment[]
}

model DealStatus {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  deals  Deal[]
}

model Deal {
  id               Int          @id @default(autoincrement())
  deal_number      String       @unique
  customer_id      Int
  deal_type        DealType
  base_currency_id Int
  quote_currency_id Int
  branch_id         Int?
  amount           Decimal
  rate             Decimal
  deal_date        DateTime
  settlement_date  DateTime
  remarks          String?
  status_id        Int
  created_by       Int?
  approved_by      Int?
  approved_at      DateTime?
  created_at       DateTime
  updated_at       DateTime
  deleted_at       DateTime?
  downloaded_at    DateTime?
  printed_at       DateTime?
  download_count   Int          @default(0)
  print_count      Int          @default(0)
  branch    Branch? @relation(fields: [branch_id], references: [id])

  status           DealStatus   @relation(fields: [status_id], references: [id])
  customer         Customer     @relation(fields: [customer_id], references: [id])
  baseCurrency     Currency     @relation("BaseCurrency", fields: [base_currency_id], references: [id])
  quoteCurrency    Currency     @relation("QuoteCurrency", fields: [quote_currency_id], references: [id])
  createdBy        User?        @relation("DealCreatedBy", fields: [created_by], references: [id])
  approvedBy       User?        @relation("DealApprovedBy", fields: [approved_by], references: [id])
  payments         Payment[]
  auditLogs         AuditLog[] 
  documents        DealDocument[]
}

model PaymentStatus {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  payments  Payment[]
}

model Payment {
  id               Int         @id @default(autoincrement())
  deal_id          Int
  payment_reference String     @unique
  payment_mode     PaymentMode
  amount           Decimal
  currency_id      Int
  payment_date     DateTime
  transaction_id   String?
  customer_bank_id Int?
  system_bank_id   Int?
  processed_by     Int?
  approved_by      Int?
  status_id        Int
  approved_at      DateTime?
  notes            String?
  created_at       DateTime
  updated_at       DateTime
  deleted_at       DateTime?
  deal             Deal        @relation(fields: [deal_id], references: [id])
  status           PaymentStatus @relation(fields: [status_id], references: [id])
  currency         Currency    @relation(fields: [currency_id], references: [id])
  customerBank     CustomerBank? @relation(fields: [customer_bank_id], references: [id])
  systemBank       SystemBank? @relation(fields: [system_bank_id], references: [id])
  processedBy      User?       @relation("PaymentProcessedBy", fields: [processed_by], references: [id])
  approvedBy       User?       @relation("PaymentApprovedBy", fields: [approved_by], references: [id])
}

model DealDocument {
  id              Int       @id @default(autoincrement())
  deal_id         Int
  file_name       String
  file_path       String
  mime_type       String?
  uploaded_by     Int?
  uploaded_at     DateTime  @default(now())

  whatsapp_sent   Boolean   @default(false)
  email_sent      Boolean   @default(false)
  notification_at DateTime?

  deal            Deal      @relation(fields: [deal_id], references: [id])
  uploadedBy      User?     @relation("UserUploadedDocuments", fields: [uploaded_by], references: [id])
}

model FxRate {
  id               Int       @id @default(autoincrement())
  base_currency_id Int
  quote_currency_id Int
  buy_rate         Decimal
  sell_rate        Decimal
  effective_date   DateTime
  created_by       Int?
  created_at       DateTime
  updated_at       DateTime
  deleted_at       DateTime?
  baseCurrency     Currency  @relation("BaseRate", fields: [base_currency_id], references: [id])
  quoteCurrency    Currency  @relation("QuoteRate", fields: [quote_currency_id], references: [id])
  createdBy        User?     @relation("FxRateCreatedBy", fields: [created_by], references: [id])
}

model AuditLog {
  id          Int       @id @default(autoincrement())
  user_id     Int
  action      String
  entity_type String
  entity_id   Int
  is_active   Boolean
  deal_id      Int?
  old_value   String?
  new_value   String?
  created_at  DateTime
  user        User      @relation(fields: [user_id], references: [id])
  deal        Deal?      @relation(fields: [deal_id], references: [id])
}

model SystemNotification {
  id          Int      @id @default(autoincrement())
  recipient_id Int
  title       String
  message     String
  is_read     Boolean
  created_at  DateTime
  recipient   User     @relation(fields: [recipient_id], references: [id])
}